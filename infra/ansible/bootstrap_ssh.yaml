---
- name: Distribute new ssh public key to workers
  hosts: workers
  become: true
  vars:
    ssh_cluster_key: /home/almalinux/.ssh/id_cluster.pub
    ansible_user: almalinux
    ansible_ssh_common_args :  >
      -o IdentitiesOnly=no
      -o PreferredAuthentications=publickey
      -i /home/almalinux/.ssh/lecturer_key


  tasks:
    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "/home/almalinux/.ssh"
        state: directory
        owner: almalinux
        group: almalinux
        mode: '0700'
    - name: Copy ssh pub key to workers
      ansible.posix.authorized_key:
        user: almalinux
        state: present
        key: "{{ lookup('ansible.builtin.file', ssh_cluster_key) }}"
